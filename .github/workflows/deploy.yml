name: Build & Deploy to Docker Hub

on:
  push:
    branches: [ "master", "develop" ]

env:
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
  FRONTEND_IMAGE: mycount-frontend
  BACKEND_IMAGE: mycount-backend
  GRAFANA_IMAGE: mycount-grafana
  PROM_IMAGE: mycount-prometheus

jobs:
  test-backend:
    name: Run Backend Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Backend Dependencies
      working-directory: backend
      run: pip install -r requirements.txt

    - name: Run Tests with Coverage
      working-directory: backend
      run: make coverage   # must generate coverage.xml

    - name: Check Coverage > 80%
      working-directory: backend
      run: |
        coverage=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
        echo "Coverage: $coverage%"
        if (( $(echo "$coverage < 80" | bc -l) )); then
          echo "Coverage below threshold"
          exit 1
        fi

  build-and-push:
    name: Build & Push Containers to Docker Hub
    needs: test-backend
    runs-on: ubuntu-latest

    env:
      DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
      FRONTEND_IMAGE: mycount-frontend
      BACKEND_IMAGE: mycount-backend
      GRAFANA_IMAGE: mycount-grafana
      PROM_IMAGE: mycount-prometheus

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    ####################################################
    # FRONTEND
    ####################################################
    - name: Build Frontend
      run: |
        docker build \
          --build-arg VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }} \
          -t $DOCKERHUB_REPO/$FRONTEND_IMAGE:latest \
          ./frontend

    - name: Push Frontend
      run: docker push $DOCKERHUB_REPO/$FRONTEND_IMAGE:latest

    - name: Deploy to Azure Container App
      run: |
        az containerapp update \
          --name mycount-frontend \
          --resource-group BCSAI2025-DEVOPS-STUDENTS-A \
          --image $DOCKERHUB_REPO/$FRONTEND_IMAGE:latest

    ####################################################
    # BACKEND
    ####################################################
    - name: Build Backend
      run: |
        docker build \
          -f backend/Dockerfile \
          -t $DOCKERHUB_REPO/$BACKEND_IMAGE:latest \
          backend

    - name: Push Backend
      run: docker push $DOCKERHUB_REPO/$BACKEND_IMAGE:latest

    - name: Deploy to Azure Container App
      run: |
        az containerapp update \
          --name mycount-backend \
          --resource-group BCSAI2025-DEVOPS-STUDENTS-A \
          --image $DOCKERHUB_REPO/$BACKEND_IMAGE:latest

    ####################################################
    # GRAFANA
    ####################################################
    - name: Build Grafana
      run: |
        docker build \
          -f monitoring/grafana/Dockerfile \
          -t $DOCKERHUB_REPO/$GRAFANA_IMAGE:latest \
          monitoring/grafana

    - name: Push Grafana
      run: docker push $DOCKERHUB_REPO/$GRAFANA_IMAGE:latest

    ####################################################
    # PROMETHEUS
    ####################################################
    - name: Build Prometheus
      run: |
        docker build \
          -f monitoring/prometheus/Dockerfile \
          -t $DOCKERHUB_REPO/$PROM_IMAGE:latest \
          monitoring/prometheus

    - name: Push Prometheus
      run: docker push $DOCKERHUB_REPO/$PROM_IMAGE:latest

    - name: Deploy to Azure Container App
      run: |
        az containerapp update \
          --name mycount-prometheus \
          --resource-group BCSAI2025-DEVOPS-STUDENTS-A \
          --image $DOCKERHUB_REPO/$PROM_IMAGE:latest
