build-and-push:
  name: Build & Push Containers to Docker Hub
  needs: test-backend
  runs-on: ubuntu-latest

  env:
    DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
    FRONTEND_IMAGE: mycount-frontend
    BACKEND_IMAGE: mycount-backend
    GRAFANA_IMAGE: mycount-grafana
    PROM_IMAGE: mycount-prometheus

  steps:
  - name: Checkout repository
    uses: actions/checkout@v3

  - name: Login to Docker Hub
    run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

  ####################################################
  # FRONTEND
  ####################################################
  - name: Build Frontend
    run: |
      docker build \
        --build-arg VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }} \
        -t $DOCKERHUB_REPO/$FRONTEND_IMAGE:latest \
        ./frontend

  - name: Push Frontend
    run: docker push $DOCKERHUB_REPO/$FRONTEND_IMAGE:latest

  ####################################################
  # BACKEND
  ####################################################
  - name: Build Backend
    run: |
      docker build \
        -f backend/Dockerfile \
        -t $DOCKERHUB_REPO/$BACKEND_IMAGE:latest \
        backend

  - name: Push Backend
    run: docker push $DOCKERHUB_REPO/$BACKEND_IMAGE:latest

  ####################################################
  # GRAFANA
  ####################################################
  - name: Build Grafana
    run: |
      docker build \
        -f monitoring/grafana/Dockerfile \
        -t $DOCKERHUB_REPO/$GRAFANA_IMAGE:latest \
        monitoring/grafana

  - name: Push Grafana
    run: docker push $DOCKERHUB_REPO/$GRAFANA_IMAGE:latest

  ####################################################
  # PROMETHEUS
  ####################################################
  - name: Build Prometheus
    run: |
      docker build \
        -f monitoring/prometheus/Dockerfile \
        -t $DOCKERHUB_REPO/$PROM_IMAGE:latest \
        monitoring/prometheus

  - name: Push Prometheus
    run: docker push $DOCKERHUB_REPO/$PROM_IMAGE:latest